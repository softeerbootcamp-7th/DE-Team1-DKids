<div align="center">
  <h1>RAG Pipeline</h1>
  <p><b>정비 문서 기반 과잉정비 판단 보조를 위한 RAG 지식베이스 구성</b></p>
</div>

---

### 1. 프로젝트 개요
- 본 문서는 과잉정비 판단 보조를 위한 RAG 지식 저장소의 데이터 구성과 핵심 테이블 구조를 정리하기 위한 문서입니다.
- RAG 검색/판단을 위해 **PostgreSQL + pgvector(Vector DB 확장)** 를 사용했습니다.
- 정비 근거 문서를 구조화하여 저장하고, 증상 기반 검색(lexical + vector similarity)에 활용하는 것을 목표로 합니다.

---

### 2. 데이터베이스 구성
- **DB 엔진**: PostgreSQL
- **벡터 검색 확장**: `pgvector`
- **활용 목적**
  - 정비 문서 원문/구조화 필드 저장
  - 증상 텍스트 기반 검색
  - 임베딩 유사도 기반 검색
  - RAG용 근거 문서 조회

---

### 3. 데이터 소스 구성 (2가지 유형)

#### 3.1 현대자동차 정비 지침서 (차종별)
- 차종별 정비 지침서를 수집하여 RAG 지식베이스에 저장했습니다.
- 주요 활용 정보:
  - 증상 관련 부품
  - 정비 방법
  - 점검/교체 판단 근거
- 역할:
  - 제조사 기준의 정비 근거 문서(차종 특화)
- 차종 특화 범위 (포함 차종):
  - 엑센트 (RB)
  - 아반떼 (AD)
  - i30 (PD)
  - 아이오닉HEV (AE)
  - i40 세단 (VF)
  - 쏘나타 (LF)
  - 그랜저 (IG)
  - G70 (IK)
  - G80 (DH)
  - EQ900 (HI)
  - 코나 (OS)
  - 투싼 (TL)
  - 싼타페 (DM)
  - 그랜드 스타렉스 (TQ)
  - 포터2

#### 3.2 공임나라 정비사 정비 꿀팁 (일반 정비 지침)
- 공임나라의 정비사들이 작성한 정비 팁 데이터를 수집하여 활용했습니다.
- 현대차 차종별 매뉴얼과 동일한 구조로 정리하여 RAG에 적재했습니다.
- 역할:
  - 일반 정비 지침(현장 경험 기반 보완 근거)

---

### 4. LLM Agent 로직 (2개 Agent)

현재 RAG 파이프라인에서는 LLM을 하나의 역할로만 쓰지 않고, 목적이 다른 **2개의 Agent**로 나누어 사용합니다.

#### 4.1 Agent 1: 증상 유사도 검증 Agent
- 역할: 검색된 후보 문서가 사용자 증상과 **정말 같은 증상 계열인지** 검증
- 입력:
  - 사용자 증상(`user_symptom`)
  - 검색 후보 문서 목록(`candidate_symptom_text`, `evidence_text` 등)
- 출력:
  - `similarity_score`
  - `keep` 여부
  - 간단한 판단 이유
- 목적:
  - 단순 키워드 일치로 잘못 검색된 문서를 걸러내기
  - 최종 진단에 들어갈 근거 문서 품질을 높이기
  - 반복 검색 과정에서 더 좋은 증거를 남기도록 피드백 신호 제공

#### 4.2 Agent 2: 최종 진단/판정 Agent
- 역할: 선별된 근거 문서와 견적 부품 정보를 바탕으로 **최종 진단 문장** 생성
- 입력:
  - 견적 부품 목록
  - 증상별 근거 문서(제조사 지침 / 일반 정비 지침)
- 출력:
  - JSON 형식의 `diagnosis_text` (최종 판정 + 근거 설명)
- 특징:
  - 문서 근거를 우선 사용
  - 부족한 경우에만 보조 판단(일반 정비 상식) 사용
  - 최종 결과는 UI에서 `과잉정비 / 표준 범위` 판정에 활용

#### 4.3 Agent 간 피드백 구조 (핵심)
- 두 Agent는 완전히 독립적으로 한 번씩만 실행되는 구조가 아니라,
  **검색 → 검증 → 재검색(쿼리 정리/범위 조정) → 재검증** 흐름 속에서 결과를 보완합니다.
- 특히 Agent 1(유사도 검증)의 결과(`keep`, `similarity_score`)는
  어떤 문서를 근거로 채택할지 결정하는 기준이 되며,
  필요하면 다음 검색 단계에서 더 적절한 후보를 다시 찾도록 유도합니다.
- 이렇게 선별된 문서 집합을 Agent 2가 최종 진단에 사용하므로,
  결과적으로 Agent들이 단계적으로 **더 좋은 증거를 가져오도록 협력하는 구조**로 동작합니다.

#### 4.4 전체 흐름 (요약)
1. 증상 기반으로 RAG 검색(lexical + vector + hybrid)
2. **Agent 1**이 검색 후보를 검증하고 근거 문서 선별
3. 필요 시 검색어/검색 범위를 조정해 재검색 및 재검증(반복)
4. 선별된 문서를 바탕으로 **Agent 2**가 최종 진단 문장 생성
5. UI에서 최종 판정 및 근거 카드로 표시

---

### 5. 핵심 테이블 설명: `repair_doc`

`repair_doc` 테이블은 정비 진단 문서를 저장하기 위한 핵심 엔티티로, 각 행이 하나의 **증상 기반 정비 근거 레코드**를 의미합니다.

#### 5.1 테이블 역할
- RAG 기반 정비 진단에 필요한 지식을 구조화하여 저장
- 증상 중심 검색 및 유사도 검색의 기준 데이터 제공
- LLM 판단 시 참조할 근거 문장/점검 규칙 제공

즉, 이 테이블은 다음 구조를 가지는 RAG 기반 정비 진단 지식 저장소라고 볼 수 있습니다.

`증상 → 시스템 분류 → 관련 부품 → 교체 전 점검 규칙 → 근거 텍스트 → 임베딩`

#### 5.2 주요 컬럼 설명

| 컬럼명 | 타입 | 설명 |
| :--- | :--- | :--- |
| `id` | `int` | 기본 키(Primary Key). 각 정비 근거 문서를 고유하게 식별 |
| `document_source` | `text` | 정비 정보 출처 구분 값 (예: 제조사 매뉴얼, 커뮤니티 정비 팁, 내부 정리 자료 등) |
| `vehicle_model` | `text` | 적용 차종 정보. 차종별 정비 지식 구분에 사용 |
| `symptom_text` | `text` | 실제 차량 증상/현상을 자연어로 저장하는 핵심 컬럼. RAG 검색 및 임베딩 매칭 기준 |
| `system_category` | `text` | 증상이 속하는 시스템 영역 분류값 (예: 엔진, 하체, 제동, 조향 등) |
| `repair_parts` | `text` | 해당 증상과 직접적으로 연관된 교체/점검 대상 부품명 |
| `pre_replace_check_rule` | `text` | 부품 교체 전 반드시 확인해야 하는 점검 조건/진단 절차(서술형). 과잉정비 판단 시 “선 점검 여부” 근거 |
| `evidence_text` | `text` | 증상-부품 인과 관계를 설명하는 정비 근거 문장 또는 매뉴얼 인용 내용. LLM 근거 생성 참고용 |
| `symptom_embedding` | `vector` | `symptom_text` 임베딩 값을 문자열 형태로 저장한 컬럼. 벡터 유사도 검색용 |

#### 5.3 설계 의도
- `symptom_text`를 중심으로 문서를 검색하고,
- `system_category`, `vehicle_model`로 검색 범위를 좁히며,
- `repair_parts`, `pre_replace_check_rule`, `evidence_text`를 근거로 LLM이 판단 설명을 생성할 수 있도록 설계했습니다.
